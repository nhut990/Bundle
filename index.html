<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T√¨m Bundle ID App Store</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #f2f2f7;
  margin: 0; padding: 20px;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
}
.container {
  width: 100%;
  max-width: 420px;
  background: #fff;
  padding: 24px 20px 30px;
  border-radius: 16px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  text-align: center;
}
h2 {
  margin: 0 0 15px;
  font-size: 22px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
h2 img {
  width: 22px; height: 22px;
}
input, select, button {
  width: 100%;
  padding: 12px 14px;
  font-size: 16px;
  border-radius: 10px;
  border: 1px solid #ccc;
  outline: none;
  box-sizing: border-box;
  margin-top: 10px;
  text-align: center;
}
select { background: #f8f8f8; text-align-last: center; }
button {
  background: #007aff;
  color: white;
  border: none;
  cursor: pointer;
  font-weight: 500;
  transition: 0.2s;
}
button:hover { background: #005ecb; }
.note {
  display: none;
  font-size: 13px;
  color: #666;
  margin-top: 10px;
  line-height: 1.5;
}
.app {
  display: flex;
  align-items: flex-start;
  border-bottom: 1px solid #eee;
  padding: 12px 0;
}
.app a img {
  width: 60px; height: 60px;
  border-radius: 12px;
  margin-right: 12px;
  transition: 0.2s;
  object-fit: cover;
  background: #f3f3f3;
}
.app a img:hover { transform: scale(1.05); }
.app-info { text-align: left; flex: 1; }
.bundle {
  background: #f1f1f1;
  padding: 4px 8px;
  border-radius: 8px;
  font-family: monospace;
  cursor: pointer;
  user-select: all;
  display: inline-block;
  color: #007aff;
}
.bundle.disabled {
  cursor: default;
  opacity: 0.6;
  user-select: text;
  color: #666;
}
.bundle:hover { background: #e5e5e5; }
#results { margin-top: 20px; text-align: left; }

.footer {
  text-align: center;
  margin-top: 25px;
  font-size: 14px;
}
.footer a {
  text-decoration: none;
  color: #007aff;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: color 0.3s ease;
}
.footer a:hover { color: #005ecb; }
.arrow {
  display: inline-block;
  transition: transform 0.4s ease, opacity 0.4s ease;
}
.footer a:active { transform: scale(0.97); }

/* Small screens tweak */
@media (max-width: 420px) {
  .container { padding: 18px 14px 22px; border-radius: 12px; }
  h2 { font-size: 20px; }
}
</style>
</head>
<body>
  <div class="container">
    <h2><img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" alt="Apple"> T√¨m Bundle ID App Store</h2>
    <input type="text" id="appName" placeholder="Nh·∫≠p t√™n ·ª©ng d·ª•ng (VD: Facebook, Zalo...)">
    <select id="country">
      <option value="VN" selected>üáªüá≥ Vi·ªát Nam</option>
      <option value="US">üá∫üá∏ Hoa K·ª≥</option>
      <option value="JP">üáØüáµ Nh·∫≠t B·∫£n</option>
      <option value="KR">üá∞üá∑ H√†n Qu·ªëc</option>
      <option value="SG">üá∏üá¨ Singapore</option>
      <option value="CN">üá®üá≥ Trung Qu·ªëc</option>
      <option value="RU">üá∑üá∫ Nga</option>
    </select>
    <button id="searchBtn">T√¨m ki·∫øm</button>
    <div class="note" id="copyNote">
      üí° ·∫§n v√†o <b>Icon</b> ƒë·ªÉ m·ªü App Store<br>
      üí° ·∫§n v√†o <b>Bundle ID</b> ƒë·ªÉ sao ch√©p
    </div>
    <div id="results"></div>

    <div class="footer">
      <a href="#" id="homeLink">
        <span class="arrow" id="arrow">‚¨ÖÔ∏è</span> Quay v·ªÅ trang ch·ªß
      </a>
    </div>
  </div>

<script>
(function () {
  var searchBtn = document.getElementById('searchBtn');
  var appNameInput = document.getElementById('appName');
  var countrySelect = document.getElementById('country');
  var resultsDiv = document.getElementById('results');
  var copyNote = document.getElementById('copyNote');
  var homeLink = document.getElementById('homeLink');
  var arrow = document.getElementById('arrow');

  // Placeholder SVG for missing artwork
  var placeholderSvg = encodeURIComponent(
    '<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100">' +
    '<rect fill="%23eee" width="100" height="100"/>' +
    '<text x="50" y="55" font-size="12" text-anchor="middle" fill="%23999">No Image</text>' +
    '</svg>'
  );
  var placeholderUrl = 'data:image/svg+xml;charset=UTF-8,' + placeholderSvg;

  searchBtn.addEventListener('click', searchApp);
  appNameInput.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') searchApp();
  });

  homeLink.addEventListener('click', function (e) {
    e.preventDefault();
    try {
      if (arrow) {
        arrow.style.transform = "translateX(-50px)";
        arrow.style.opacity = "0";
      }
      setTimeout(function () { window.location.href = "https://nhut990.github.io"; }, 400);
    } catch (err) {
      window.location.href = "https://nhut990.github.io";
    }
  });

  // Fetch with fallbacks:
  // 1) native fetch -> res.json()
  // 2) XHR GET
  // 3) JSONP (itunes supports callback=)
  function fetchWithFallback(url, timeoutMs) {
    timeoutMs = timeoutMs || 10000;
    return new Promise(function (resolve, reject) {
      var settled = false;

      function doResolve(data) { if (!settled) { settled = true; resolve(data); } }
      function doReject(err) { if (!settled) { settled = true; reject(err); } }

      // Try native fetch first if available
      if (window.fetch) {
        var didTimeout = false;
        var timer = setTimeout(function () {
          didTimeout = true;
        }, timeoutMs);

        window.fetch(url).then(function (res) {
          clearTimeout(timer);
          if (didTimeout) {
            // timed out, fallback to next method
            tryXHR();
            return;
          }
          if (!res.ok) {
            // Try XHR/JSONP fallback
            tryXHR();
            return;
          }
          return res.json().then(doResolve).catch(function () { tryXHR(); });
        }).catch(function () {
          clearTimeout(timer);
          tryXHR();
        });
      } else {
        tryXHR();
      }

      // XHR fallback
      function tryXHR() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.timeout = timeoutMs;
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                var data = JSON.parse(xhr.responseText);
                doResolve(data);
              } catch (e) {
                // parse error -> JSONP fallback
                tryJSONP();
              }
            } else {
              // status error -> JSONP fallback
              tryJSONP();
            }
          }
        };
        xhr.ontimeout = function () { tryJSONP(); };
        xhr.onerror = function () { tryJSONP(); };
        try {
          xhr.send();
        } catch (e) {
          tryJSONP();
        }
      }

      // JSONP fallback (uses callback parameter)
      function tryJSONP() {
        var callbackName = 'itunes_cb_' + Math.floor(Math.random() * 1000000);
        var script = document.createElement('script');
        var timedOut = false;
        var timer = setTimeout(function () {
          timedOut = true;
          cleanup();
          doReject(new Error('JSONP timeout'));
        }, timeoutMs);

        window[callbackName] = function (data) {
          if (timedOut) return;
          cleanup();
          doResolve(data);
        };

        function cleanup() {
          clearTimeout(timer);
          try { delete window[callbackName]; } catch (e) { window[callbackName] = undefined; }
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        // append callback param (itunes supports callback)
        var sep = url.indexOf('?') === -1 ? '?' : '&';
        script.src = url + sep + 'callback=' + callbackName;
        script.onerror = function () {
          cleanup();
          doReject(new Error('JSONP load failed'));
        };
        document.head.appendChild(script);
      }
    });
  }

  function searchApp() {
    try {
      var name = (appNameInput.value || '').trim();
      var country = countrySelect.value;
      resultsDiv.innerHTML = 'üîç ƒêang t√¨m...';
      copyNote.style.display = 'none';

      if (!name) {
        resultsDiv.innerHTML = '‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n ·ª©ng d·ª•ng.';
        return;
      }

      // N·∫øu tr√¨nh duy·ªát h·ªó tr·ª£ normalize th√¨ d√πng, n·∫øu kh√¥ng th√¨ d√πng lowercased raw string
      var term;
      if (typeof String.prototype.normalize === 'function') {
        term = name.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
      } else {
        term = name.toLowerCase();
      }

      var url = 'https://itunes.apple.com/search?term=' + encodeURIComponent(term) +
                '&country=' + encodeURIComponent(country) + '&entity=software&limit=10';

      fetchWithFallback(url, 10000).then(function (data) {
        if (!data || !data.results || data.results.length === 0) {
          resultsDiv.innerHTML = '‚ùå Kh√¥ng t√¨m th·∫•y ·ª©ng d·ª•ng n√†o trong khu v·ª±c n√†y.';
          return;
        }

        // Ensure we try lookup for bundleId if missing
        var results = data.results;
        var lookupPromises = results.map(function (app) {
          if ((!app.bundleId || app.bundleId === '') && app.trackId) {
            var lookupUrl = 'https://itunes.apple.com/lookup?id=' + encodeURIComponent(app.trackId);
            return fetchWithFallback(lookupUrl, 8000).then(function (lookupData) {
              if (lookupData && lookupData.results && lookupData.results[0] && lookupData.results[0].bundleId) {
                app.bundleId = lookupData.results[0].bundleId;
              }
              return app;
            }).catch(function () { return app; });
          } else {
            return Promise.resolve(app);
          }
        });

        Promise.all(lookupPromises).then(function (apps) {
          renderResults(apps);
        }).catch(function (err) {
          // Even if lookup fails, render initial results
          renderResults(results);
        });

      }).catch(function (err) {
        console.error(err);
        resultsDiv.innerHTML = '‚ö†Ô∏è L·ªói khi truy v·∫•n API (' + (err && err.message ? err.message : 'Load failed.') + ').';
      });
    } catch (err) {
      console.error('Unexpected error in searchApp', err);
      resultsDiv.innerHTML = '‚ö†Ô∏è L·ªói n·ªôi b·ªô, vui l√≤ng th·ª≠ l·∫°i.';
    }
  }

  function renderResults(apps) {
    resultsDiv.innerHTML = '';
    copyNote.style.display = 'block';

    apps.forEach(function (app) {
      var appEl = document.createElement('div');
      appEl.className = 'app';

      var link = document.createElement('a');
      link.href = app.trackViewUrl || '#';
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      link.title = 'M·ªü trong App Store';

      var img = document.createElement('img');
      img.src = app.artworkUrl100 || placeholderUrl;
      img.alt = app.trackName || 'App';
      img.addEventListener('error', function () { this.src = placeholderUrl; });

      link.appendChild(img);
      appEl.appendChild(link);

      var info = document.createElement('div');
      info.className = 'app-info';

      var title = document.createElement('div');
      var b = document.createElement('b');
      b.style.color = '#007aff';
      b.textContent = app.trackName || 'Kh√¥ng r√µ';
      title.appendChild(b);

      var versionSpan = document.createElement('span');
      versionSpan.style.color = '#555';
      versionSpan.style.marginLeft = '6px';
      versionSpan.textContent = '(v' + (app.version || app.versionString || 'N/A') + ')';
      title.appendChild(versionSpan);

      info.appendChild(title);

      var bundleLine = document.createElement('div');
      var bundleSpan = document.createElement('span');
      bundleSpan.className = 'bundle';
      if (app.bundleId) {
        bundleSpan.textContent = app.bundleId;
        bundleSpan.addEventListener('click', function () { copyBundle(app.bundleId); });
      } else {
        bundleSpan.textContent = 'Kh√¥ng r√µ';
        bundleSpan.className += ' disabled';
      }
      bundleLine.appendChild(bundleSpan);
      info.appendChild(bundleLine);

      var seller = document.createElement('div');
      seller.innerHTML = '<small>' + escapeHtml(app.sellerName || 'Kh√¥ng r√µ') + '</small>';
      info.appendChild(seller);

      var iosReq = document.createElement('div');
      iosReq.innerHTML = '<small>Y√™u c·∫ßu: ' + escapeHtml(app.minimumOsVersion || 'Kh√¥ng r√µ') + ' tr·ªü l√™n</small>';
      info.appendChild(iosReq);

      var updated = document.createElement('div');
      var dateText = app.currentVersionReleaseDate ? new Date(app.currentVersionReleaseDate).toLocaleDateString('vi-VN') : 'Kh√¥ng r√µ';
      updated.innerHTML = '<small>C·∫≠p nh·∫≠t: ' + escapeHtml(dateText) + '</small>';
      info.appendChild(updated);

      var price = document.createElement('div');
      price.innerHTML = '<small>' + escapeHtml(app.formattedPrice || (app.price === 0 || app.price === '0' ? 'Free' : 'Free')) + '</small>';
      info.appendChild(price);

      appEl.appendChild(info);
      resultsDiv.appendChild(appEl);
    });
  }

  // Copy to clipboard with fallback
  function copyBundle(bundle) {
    if (!bundle) return;
    var showCopied = function (text) {
      var temp = document.createElement('div');
      temp.textContent = '‚úÖ ƒê√£ sao ch√©p: ' + text;
      temp.style.position = 'fixed';
      temp.style.bottom = '20px';
      temp.style.left = '50%';
      temp.style.transform = 'translateX(-50%)';
      temp.style.background = 'rgba(0,0,0,0.8)';
      temp.style.color = 'white';
      temp.style.padding = '8px 14px';
      temp.style.borderRadius = '10px';
      temp.style.fontSize = '14px';
      temp.style.zIndex = '9999';
      document.body.appendChild(temp);
      setTimeout(function () { temp.remove(); }, 1500);
    };

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(bundle).then(function () { showCopied(bundle); }).catch(function () { fallbackCopy(bundle, showCopied); });
    } else {
      fallbackCopy(bundle, showCopied);
    }
  }

  function fallbackCopy(text, cb) {
    var input = document.createElement('textarea');
    input.value = text;
    input.style.position = 'fixed';
    input.style.left = '-9999px';
    document.body.appendChild(input);
    input.select();
    try {
      document.execCommand('copy');
      if (cb) cb(text);
    } catch (e) {
      console.error('Copy fallback failed', e);
    }
    document.body.removeChild(input);
  }

  function escapeHtml(str) {
    if (str === null || typeof str === 'undefined') return '';
    return String(str).replace(/[&<>"'`=\/]/g, function (s) {
      return ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
        '/': '&#x2F;',
        '`': '&#x60;',
        '=': '&#x3D;'
      })[s];
    });
  }
})();
</script>
</body>
</html>